app-id: io.github.softfever.OrcaSlicer
runtime: org.gnome.Platform
runtime-version: "45"
sdk: org.gnome.Sdk
command: entrypoint
separate-locales: true
rename-icon: OrcaSlicer 
finish-args:
  - --share=ipc
  - --socket=x11
  - --share=network
  - --device=all
  - --filesystem=home
  - --filesystem=xdg-run/gvfs
  - --filesystem=/run/media
  - --filesystem=/media
  # Allow OrcaSlicer to talk to other instances
  - --talk-name=io.github.softfever.OrcaSlicer.InstanceCheck.*
  - --system-talk-name=org.freedesktop.UDisks2
  # set dark theme
  - --env=BAMBU_STUDIO_DARK_THEME=false

modules:

  # JPEG codec for the liveview
  - name: gst-plugins-good
    buildsystem: meson
    config-opts:
      - -Dauto_features=disabled
      - -Djpeg=enabled
      - -Ddoc=disabled
      - -Dexamples=disabled
      - -Dtests=disabled
    sources:
      - type: archive
        url: https://gstreamer.freedesktop.org/src/gst-plugins-good/gst-plugins-good-1.22.8.tar.xz
        sha256: e305b9f07f52743ca481da0a4e0c76c35efd60adaf1b0694eb3bb021e2137e39

  # xprop, xlib is needed to manipulate the X11 window and set _GTK_THEME_VARIANT dark on X11
  # and paint the window dark when PRUSA_SLICER_DARK_THEME is true
  # see: entrypoint & set-dark-theme-variant.py (originated from spotify client flatpak)
  - name: xprop
    sources:
      - type: archive
        url: http://mirrors.ircam.fr/pub/x.org/individual/app/xprop-1.2.5.tar.gz
        sha256: b7bf6b6be6cf23e7966a153fc84d5901c14f01ee952fbd9d930aa48e2385d670
  - name: python-flit_core
    buildsystem: simple
    build-commands:
      - pip3 install --no-deps --no-build-isolation --verbose --prefix=${FLATPAK_DEST} .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/c4/e6/c1ac50fe3eebb38a155155711e6e864e254ce4b6e17fe2429b4c4d5b9e80/flit_core-3.9.0.tar.gz
        sha256: 72ad266176c4a3fcfab5f2930d76896059851240570ce9a98733b658cb786eba
  - name: python-packaging
    buildsystem: simple
    build-commands:
      - pip3 install --no-deps --no-build-isolation --verbose --prefix=${FLATPAK_DEST} .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/51/65/50db4dda066951078f0a96cf12f4b9ada6e4b811516bf0262c0f4f7064d4/packaging-24.1.tar.gz
        sha256: 026ed72c8ed3fcce5bf8950572258698927fd1dbda10a5e981cdf0ac37f4f002
  - name: python-setuptools_scm
    buildsystem: simple
    build-commands:
      - pip3 install --no-deps --no-build-isolation --verbose --prefix=${FLATPAK_DEST} .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/57/38/930b1241372a9f266a7df2b184fb9d4f497c2cef2e016b014f82f541fe7c/setuptools_scm-6.0.1.tar.gz
        sha256: d1925a69cb07e9b29416a275b9fadb009a23c148ace905b2fb220649a6c18e92
  - name: python-xlib
    buildsystem: simple
    build-commands:
      - pip3 install --no-deps --no-build-isolation --verbose --prefix=${FLATPAK_DEST} .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/86/f5/8c0653e5bb54e0cbdfe27bf32d41f27bc4e12faa8742778c17f2a71be2c0/python-xlib-0.33.tar.gz
        sha256: 55af7906a2c75ce6cb280a584776080602444f75815a7aff4d287bb2d7018b32

  # For libOSMesa
  - name: mesa
    buildsystem: meson
    config-opts:
      - -Dosmesa=classic
      - -Ddri-drivers=[]
      - -Dgallium-drivers=[]
      - -Dvulkan-drivers=[]
      - -Dplatforms=[]
    build-options:
      arch:
        aarch64:
          config-opts:
            - -Dlibunwind=disabled
    cleanup:
      - /share/drirc.d
      - /include
      - "*.a"
    sources:
      - type: archive
        url: https://archive.mesa3d.org/mesa-20.2.6.tar.xz
        sha256: f12ca3c6c622f11cd79ad66b4220f04514fa96f795062fe92a37339ab19885db

  - name: glu
    config-opts:
      - --disable-static
    sources:
      - type: archive
        url: https://ftp.osuosl.org/pub/blfs/conglomeration/glu/glu-9.0.2.tar.xz
        sha256: 6e7280ff585c6a1d9dfcdf2fca489251634b3377bfc33c29e4002466a38d02d4
    cleanup:
      - /include
      - /lib/*.a
      - /lib/*.la
      - /lib/pkgconfig

  - name: kde-extra-cmake-modules
    buildsystem: cmake-ninja
    sources:
      - type: git
        url: https://github.com/KDE/extra-cmake-modules
        tag: v5.249.0
    cleanup:
      - /

  - name: orca_deps
    build-options:
      build-args:
        - --share=network
    buildsystem: simple
    build-commands:
      # start build
      - |
        cmake -B deps/build -S deps \
          -GNinja \
          -DDEP_WX_GTK3=ON \
          -DDEP_DOWNLOAD_DIR=/run/build/orca_deps/external-packages \
          -DCMAKE_PREFIX_PATH=/app \
          -DDESTDIR=/app \
          -DCMAKE_INSTALL_LIBDIR=/app/lib \
          -DFLATPAK=ON \
          -DCMAKE_INSTALL_PREFIX=/app
        cmake --build build --target dep_wxWidgets
        cmake --build build

    cleanup:
      - /app/include
      - "*.a"
      - "*.la"
      - "*.cmake"
      - /app/lib/cmake

    sources:
      # OrcaSlicer Source Archive
      - type: dir
        path: ../

  - name: OrcaSlicer 
    buildsystem: simple
    build-commands:
      - |
        rm -rf .git
        cmake . -B build \
          -DSLIC3R_PCH=OFF \
          -DSLIC3R_FHS=ON \
          -DSLIC3R_GTK=3 \
          -DSLIC3R_STATIC=ON \
          -DSLIC3R_BUILD_TESTS=OFF \
          -DSLIC3R_DESKTOP_INTEGRATION=OFF \
          -DCMAKE_BUILD_TYPE=Release \
          -DFLATPAK=ON \
          -DBBL_RELEASE_TO_PUBLIC=1 \
          -DCMAKE_PREFIX_PATH=/app \
          -DCMAKE_INSTALL_PREFIX=/app
        cmake --build build --target install -j$FLATPAK_BUILDER_N_JOBS

    cleanup:
      - /include

    post-install:

      - | # Desktop Integration files
        install -Dm644 -t /app/share/icons/hicolor/scalable/apps/ resources/images/OrcaSlicer.svg
        install -Dm644 ${FLATPAK_ID}.metainfo.xml /app/share/metainfo/${FLATPAK_ID}.metainfo.xml
        mv /app/share/applications/OrcaSlicer.desktop /app/share/applications/${FLATPAK_ID}.desktop
        desktop-file-edit --set-key=Exec --set-value="entrypoint %U" /app/share/applications/${FLATPAK_ID}.desktop
        install -Dm755 set-dark-theme-variant.py /app/bin
        install -Dm755 entrypoint /app/bin
        install -Dm755 umount /app/bin

    sources:
      # -
      # Section bellow fetches all OrcaSlicer dependencies before the build process and stores them in external-packages/*/* .
      # -DDEP_DOWNLOAD_DIR is set in the build process which has to match with dest.
      #
      # NOTE: The url, dest folder name and sha256 must match from OrcaSlicer's cmake scripts and folder names in OrcaSlicer/deps/
      # -

      # OrcaSlicer Source Archive
      - type: dir 
        path: ../

      # AppData metainfo for Gnome Software & Co.
      - type: file
        path: io.github.softfever.OrcaSlicer.metainfo.xml

      # script to set dark theme variant
      - type: file
        path: set-dark-theme-variant.py

      # start-up script
      # README: workaround for the following issues, also enables dark theme variant:
      # SEE: https://github.com/flathub/com.bambulab.BambuStudio/issues/27
      # SEE: https://github.com/flathub/com.bambulab.BambuStudio/issues/3
      # SEE: https://github.com/prusa3d/PrusaSlicer/issues/2365
      - type: file
        path: entrypoint

      # umount wrapper used to redirect umount calls to udisk2
      - type: file
        path: umount
